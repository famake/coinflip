name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: self-hosted  # Uses your self-hosted runner
    
    # Set working directory to the main deployment location
    defaults:
      run:
        working-directory: /opt/coinflip
    
    steps:
      - name: Pull latest changes
        run: |
          git fetch origin
          git reset --hard origin/main
          
      - name: Set permissions
        run: chmod +x deploy.sh
        
      - name: Run deployment script
        run: ./deploy.sh
        
      - name: Verify containers are running
        run: |
          echo "üìä Final status check..."
          docker compose ps
          
          # One more verification that the app is accessible
          if curl -f http://localhost:80 > /dev/null 2>&1; then
            echo "‚úÖ Deployment verified - application is accessible!"
          else
            echo "‚ö†Ô∏è  Warning: Application may not be accessible on port 80"
            echo "This is expected if SWAG is proxying all traffic"
          fi
          
      - name: Notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment succeeded at $(date)"
          else
            echo "‚ùå Deployment failed at $(date)"
          fi
